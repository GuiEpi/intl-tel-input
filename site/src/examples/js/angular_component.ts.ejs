import "zone.js";
import "@angular/compiler";
import { bootstrapApplication } from "@angular/platform-browser";
import { Component, OnInit, ViewChild } from "@angular/core";
import { FormControl, FormGroup, ReactiveFormsModule, Validators } from "@angular/forms";
import IntlTelInput from "../../../build/intl-tel-input/angular/IntlTelInput.js";

@Component({
  selector: "#app",
  template: `
    <form [formGroup]="fg" (ngSubmit)="handleSubmit()" class="row g-2">
      <div class="col-auto">
        <intl-tel-input
          #telInput
          formControlName="phone"
          name="phone"
          initialCountry="us"
          [loadUtils]="loadUtils"
          searchInputClass="form-control"
          [inputProps]="{ class: 'form-control', title: 'Enter your phone number' }"
        />
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" type="submit">
          Validate
        </button>
      </div>
      <div class="notice">
        @if (phone?.errors?.["required"] && phone?.touched) {
          Please enter a number
        } @else if (phone?.errors?.["invalidPhone"] && phone?.touched) {
          {{ phone?.errors?.["invalidPhone"].errorMessage }}
        } @else if (isSubmitted && fg.valid) {
          Valid number: {{ telInput.getInstance()?.getNumber() }}
        }
      </div>
    </form>
  `,
  standalone: true,
  imports: [IntlTelInput, ReactiveFormsModule]
})
export class AppComponent implements OnInit {
  @ViewChild("telInput") telInput!: IntlTelInput;

  loadUtils = () => import('<%= cacheBust('/intl-tel-input/js/utils.js') %>');

  fg: FormGroup = new FormGroup({
    phone: new FormControl<string>("", [Validators.required]),
  });

  isSubmitted = false;

  get phone() {
    return this.fg.get("phone");
  }

  ngOnInit(): void {
    this.phone?.valueChanges.subscribe(() => {
      this.isSubmitted = false;
    });
  }

  handleSubmit(): void {
    this.phone?.markAsTouched();
    if (this.fg.valid) {
      this.isSubmitted = true;
    }
  }
}

bootstrapApplication(AppComponent)
  .catch((err) => console.error(err));
